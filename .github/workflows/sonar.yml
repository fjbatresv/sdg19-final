name: Sonar

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:

permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: web
            project_key: sdg19-web
            sources: apps/web/src
          - app: backend
            project_key: sdg19-backend
            sources: apps/backend/src
          - app: infra
            project_key: sdg19-infra
            sources: apps/infra/src
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: 24
          cache: 'npm'

      - name: Verify Node 24 runtime
        run: |
          node -p "process.version"
          node -p "process.versions"
          node -e "const { AsyncLocalStorage } = require('node:async_hooks'); const als = new AsyncLocalStorage(); als.run({ ok: true }, () => { if (!als.getStore()?.ok) { throw new Error('AsyncLocalStorage failed'); } });"

      - name: Install dependencies (workspace)
        run: npm ci

      - name: Run tests with coverage (${{ matrix.app }})
        run: |
          case "${{ matrix.app }}" in
            web)
              npx nx run web:test --configuration=ci
              ;;
            backend)
              npx nx run backend:test --configuration=ci
              ;;
            infra)
              npx nx run infra:test --configuration=ci
              ;;
            *)
              echo "Unknown app: ${{ matrix.app }}"
              exit 1
              ;;
          esac

      - name: SonarCloud scan (${{ matrix.app }})
        uses: SonarSource/sonarcloud-github-action@ffc3010689be73b8e5ae0c57ce35968afd7909e8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ matrix.project_key }}
            -Dsonar.organization=fjbatresv
            -Dsonar.sources=${{ matrix.sources }}
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/coverage/**,**/*.spec.ts,**/*.test.ts,**/*.spec.js,**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/apps/${{ matrix.app }}/lcov.info
            -Dsonar.typescript.lcov.reportPaths=coverage/apps/${{ matrix.app }}/lcov.info
