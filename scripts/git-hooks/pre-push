#!/bin/bash
set -euo pipefail

DUMMY_AWS_ACCOUNT_ID=${DUMMY_AWS_ACCOUNT_ID:-123456789012}
DUMMY_ROOT_DOMAIN=${DUMMY_ROOT_DOMAIN:-example.com}
DUMMY_HOSTED_ZONE_ID=${DUMMY_HOSTED_ZONE_ID:-Z000000000000}
DUMMY_API_DOMAIN=${DUMMY_API_DOMAIN:-api.example.com}
DUMMY_WEB_DOMAIN=${DUMMY_WEB_DOMAIN:-web.example.com}
DUMMY_SES_FROM=${DUMMY_SES_FROM:-no-reply@example.com}
DUMMY_SES_MAIL_FROM=${DUMMY_SES_MAIL_FROM:-mail.example.com}
DUMMY_ENABLE_LAMBDA_VPC=${DUMMY_ENABLE_LAMBDA_VPC:-false}

echo "üöÄ Pre-push: ejecutando cdk synth con par√°metros dummy..."
AWS_ACCOUNT_ID=$DUMMY_AWS_ACCOUNT_ID \
  ROOT_DOMAIN=$DUMMY_ROOT_DOMAIN \
  HOSTED_ZONE_ID=$DUMMY_HOSTED_ZONE_ID \
  API_DOMAIN=$DUMMY_API_DOMAIN \
  WEB_DOMAIN=$DUMMY_WEB_DOMAIN \
  SES_FROM_ADDRESS=$DUMMY_SES_FROM \
  SES_MAIL_FROM_DOMAIN=$DUMMY_SES_MAIL_FROM \
  ENABLE_LAMBDA_VPC=$DUMMY_ENABLE_LAMBDA_VPC \
  npx cdk synth \
    -c rootDomainName=$DUMMY_ROOT_DOMAIN \
    -c hostedZoneId=$DUMMY_HOSTED_ZONE_ID \
    -c apiDomainName=$DUMMY_API_DOMAIN \
    -c webDomainName=$DUMMY_WEB_DOMAIN \
    -c sesFromAddress=$DUMMY_SES_FROM \
    -c sesMailFromDomain=$DUMMY_SES_MAIL_FROM \
    -c enableLambdaVpc=$DUMMY_ENABLE_LAMBDA_VPC \
    --silent

echo "üßπ Pre-push: sanitizando cdk.out..."
if [ -d "cdk.out" ]; then
    echo "üßπ Sanitizando cdk.out..."

    ./sanitize-cdk-out.sh

    if [ $? -ne 0 ]; then
        echo "‚ùå Error al sanitizar cdk.out"
        exit 1
    fi

    git add cdk.out/
    if git diff --cached --quiet -- cdk.out; then
        echo "‚ÑπÔ∏è  cdk.out sin cambios, no hay commit"
    else
        git commit -m "cdk.out updated and sanitized" --no-verify
    fi


    echo "‚úÖ cdk.out sanitizado y agregado al commit"
else
    echo "‚ÑπÔ∏è  No se encontr√≥ cdk.out, omitiendo sanitizaci√≥n"
fi
echo "üéâ Pre-push completado exitosamente"
